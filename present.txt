
# Special delimiter marking end of message
END_MARKER = "1111111111111110"

# Read image and pixels
def read_image(image_path):
    image = Image.open(image_path).convert("RGB")
    pixels = image.load()
    return image, pixels

# Read text file contents
def read_text_file(file_path):
    with open(file_path, "r", encoding="utf-8") as file:
        return file.read().strip()  # Ensure no extra BOM or whitespace

# Convert text to binary with end marker
def text_to_binary(text):
    return ''.join(format(ord(char), '08b') for char in text) + END_MARKER

# Convert binary to text
def binary_to_text(binary):
    try:
        chars = [binary[i:i+8] for i in range(0, len(binary), 8)]
        return ''.join(chr(int(char, 2)) for char in chars)
    except ValueError:
        return "[Error] Binary conversion failed!"

# Encode message into an image
def encode_text(image_path, text_file, output_image_path):
    image, pixels = read_image(image_path)
    message = read_text_file(text_file)  
    binary_message = text_to_binary(message)
    
    width, height = image.size
    index = 0

    for y in range(height):
        for x in range(width):
            if index < len(binary_message):
                r, g, b = pixels[x, y]
                r_new = (r & ~1) | int(binary_message[index])  # Modify only LSB
                pixels[x, y] = (r_new, g, b)
                index += 1
            else:
                image.save(output_image_path)
                print(f"Text from {text_file} encoded successfully in {output_image_path}")
                return

# Decode message from an image
def decode_text(image_path, output_text_file):
    image, pixels = read_image(image_path)
    width, height = image.size

    binary_message = ""

    for y in range(height):
        for x in range(width):
            r, _, _ = pixels[x, y]
            binary_message += str(r & 1)

            if binary_message.endswith(END_MARKER):
                binary_message = binary_message[:-len(END_MARKER)]  # Remove delimiter
                decoded_text = binary_to_text(binary_message)

                with open(output_text_file, "w", encoding="utf-8") as file:
                    file.write(decoded_text)

                print(f"Decoded message saved in {output_text_file}")
                return decoded_text

    print("[ERROR] Decoding failed: End marker not found")
    return None

# Example Usage:
encode_text("butter.jpg", "abc.txt", "encoded_butter.jpg")
decode_text("encoded_butter.jpg", "decoded_abc.txt")
